---
title: "MSwM package"
date: "February 22, 2017"
output: pdf_document
---

The package for implementing Autoregressive Markov switching model

```{r, eval=FALSE}
msmFit(object, k, sw, p, data, family, control)
```

- `object`: formula of class "lm"
    - Dependent variable: $TotCpu$
    - Independent variables: $RrcConnectionSetupComplete$, $X2HandoverRequest$, $Paging$, ... (a subset of components in $EventsPerSec$)
    
- `k`: Number of states (regime)
- `sw`: Swiching coefficient
- `p`: Order of AR model
- `control`: A list of control parameters


```{r, message=FALSE, warning=FALSE}
library(MSwM)
g2_L16B_min <- read.csv("C:/Users/EARAEAM/Documents/Thesis/Data/g2_L16B_min.csv")
colnames(g2_L16B_min)[14] <- "TotCpu" # need to rename the variable by removing %

train_num <- floor(nrow(g2_L16B_min) * 0.8) # divide train (80) test (20)
train_g2_L16B_min <- g2_L16B_min[1:train_num,]
test_g2_L16B_min <- g2_L16B_min[-c(1:train_num),]

predictor <- c("RrcConnectionSetupComplete","Paging","X2HandoverRequest") 
fmla <- as.formula(paste("TotCpu ~ ", paste(predictor, collapse= "+")))
mod <- lm(fmla, data=train_g2_L16B_min)

set.seed(12)
# fit model with three states and first order autoregressive
model_mswm <- msmFit(mod, k=3, p=1, sw=rep(TRUE,length(mod$coefficients)+1+1), 
                      control=list(trace=FALSE, maxiter=500, parallel=FALSE))
```


# Output

- `std`: standard deviation for each state
- `Coef`: coefficients of the model
- `seCoef`: statndard errors of the coefficients
- `transMat`: transition probabilities matrix of the states
- `Fit`: values obtained for fitting model with EM algorithm
    - `CondMean`: conditional mean for each state
    - `error`: conditional residuals of the model for each state
    - `Likel`: likelihood for each state
    - `margLik`: marginal likelihood for each observation
    - `filtProb`: filtered probabilities for each state
    - `smoProb`: smoothed probabilities for each state
    - `smoTransMat`: smoothed probabilities for each observation between all the states
    - `logLikel`: global loglikelihood of the model


### Parameter estimation

```{r}
summary(model_mswm)
```

## Graphic

### Residuals plot for each regime with the conditional residuals

```{r}
plot(model_mswm)
```

### plotDiag: Plot for the residual analysis

```{r, echo=FALSE, fig.width=6, fig.height=4}
plotDiag(model_mswm, regime=1, which=1)
plotDiag(model_mswm, regime=1, which=2)
plotDiag(model_mswm, regime=1, which=3)
```

```{r, echo=FALSE, fig.width=6, fig.height=6}
plotDiag(model_mswm, regime=1, which=3)
```

### plotProb: Plot of filtered and smoothed probabilities

```{r, echo=FALSE, fig.width=6, fig.height=6}
plotProb(model_mswm,which=1)
plotProb(model_mswm,which=2)
plotProb(model_mswm,which=3)
plotProb(model_mswm,which=4)
```

### plotReg: Plot with the response and the explanatory variables with smoothed probabilities 

```{r, echo=FALSE, fig.width=6, fig.height=6}
plotReg(model_mswm, expl=predictor[1], regime=1)
plotReg(model_mswm, expl=predictor[2], regime=1)
plotReg(model_mswm, expl=predictor[3], regime=1)
```


# Modeling

